; NekoMake build script for nekosys
;

; Compiler
GCC = neko-gcc

; Compiler base config
CCBASECONF = -std=gnu++11 -Wall -Wextra -O2 -mgeneral-regs-only -mno-red-zone -fno-exceptions -fno-pie -fno-rtti

; Compiler flags for kernel
KFLAGS = -ffreestanding -nostdlib -lelf -lk

; Assembler
[asm, multi]:
    nasm -f {format=bin} {input} -o {output}

; Kernel compiler
[kcc, single]:
    {GCC} {input} -o {output} -T kernel.ld {KFLAGS} {CCBASECONF}

; Lib compiler
[flibcc, multi]:
    {GCC} -c {input} -o {output} {CCBASECONF} {flags}
[libcc, multi]:
    {GCC} -c {input} -o {output} {CCBASECONF}

; GNU ar
[ar, multi]:
    ar rcs {output} {input}

; Default: Compile everything
default:
    % clean
    % sysroot
    % libk
    % libc
    % libelf
    % bootloader
    % kernel

; Reset build directory
clean:
    rm -rf build/
    rm -rf sysroot/

    ; Build dirs
    mkdir -p build/kernel
    mkdir -p build/libk
    mkdir -p build/libc
    mkdir -p build/libelf

    ; Sysroot
    mkdir -p sysroot/usr/include
    mkdir -p sysroot/usr/lib

; Set up the sysroot
sysroot:
    cp -RT kernel/include sysroot/usr/include
    cp -RT libc/include sysroot/usr/include
    cp -RT libelf/include sysroot/usr/include
    cp -RT libneko sysroot/usr/include

; Compile kernel version of libc
libk:
    [flibcc]
        input: libc/**.c
               libc/**.cpp
        flags: -ffreestanding -D__KERNEL
        output: build/libk/~.o
    [ar]
        input: build/libk/*.o
        output: sysroot/usr/lib/libk.a

; Compile regular libc
libc:
    [flibcc]
        input: libc/**.c
               libc/**.cpp
        flags: -ffreestanding 
        output: build/libc/~.o
    [ar]
        input: build/libc/*.o
        output: sysroot/usr/lib/libc.a

libelf:
    [libcc]
        input: libelf/**.cpp
        output: build/libelf/~.o
    [ar]
        input: build/libelf/*.o
        output: sysroot/usr/lib/libelf.a

; Compiles the bootloader
bootloader:
    [asm]
        input: boot/*.asm
        output: build/~.bin  

; Compiles the kernel
kernel:
    [asm]
        input: kernel/**.asm
        format: elf32
        output: build/kernel/~.o

    [kcc]
        input: build/kernel/*.o
               kernel/**.cpp
        output: build/NEKOKRNL

; Creates a bootable image
image:
    cp build/NEKOKRNL fsroot
    nkimg -s build/boot.bin -l build/loader.bin -r fsroot -o build/neko.img

; Compile, create an image, and run in QEMU
run:
    % default
    % image
    qemu-system-i386 -m 512M -drive format=raw,file=build/neko.img -usb -vga std -d cpu_reset -no-reboot